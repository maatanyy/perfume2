{% extends "base.html" %}

{% block title %}ì‘ì—… ìƒì„¸{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h3>{{ job.site_name }} í¬ë¡¤ë§</h3>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">ìƒíƒœ</dt>
                    <dd class="col-sm-9">
                        <span class="badge bg-{{ 'success' if job.status == 'completed' else 'warning' if job.status == 'running' else 'danger' }}">
                            {{ job.status }}
                        </span>
                    </dd>
                    <dt class="col-sm-3">ì‹œíŠ¸ ì´ë¦„</dt>
                    <dd class="col-sm-9">{{ job.sheet_name }}</dd>
                    <dt class="col-sm-3">ì§„í–‰ë¥ </dt>
                    <dd class="col-sm-9">
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ job.progress }}%">{{ job.progress }}%</div>
                        </div>
                        {{ job.processed_items }}/{{ job.total_items }}
                    </dd>
                    <dt class="col-sm-3">ì‹œì‘ ì‹œê°„</dt>
                    <dd class="col-sm-9">{{ job.started_at.strftime('%Y-%m-%d %H:%M:%S KST') if job.started_at else '-' }}</dd>
                    <dt class="col-sm-3">ì™„ë£Œ ì‹œê°„</dt>
                    <dd class="col-sm-9">{{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S KST') if job.completed_at else '-' }}</dd>
                    {% if job.error_message %}
                    <dt class="col-sm-3">ì—ëŸ¬ ë©”ì‹œì§€</dt>
                    <dd class="col-sm-9 text-danger">{{ job.error_message }}</dd>
                    {% endif %}
                </dl>
                
                {% if job.status in ['pending', 'running'] %}
                <form method="POST" action="{{ url_for('dashboard.cancel_job', job_id=job.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-warning" onclick="return confirm('ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‘ì—… ì·¨ì†Œ</button>
                </form>
                {% endif %}
                {% if job.status == 'completed' and job.result_file %}
                <a href="{{ url_for('dashboard.download_result', job_id=job.id) }}" class="btn btn-success">
                    ğŸ“¥ ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                </a>
                {% endif %}
                {% if job.status not in ['running'] %}
                <form method="POST" action="{{ url_for('dashboard.delete_job', job_id=job.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê²ŒìŠµë‹ˆê¹Œ? ëª¨ë“  ë¡œê·¸ê°€ ì‚­ì œë©ë‹ˆë‹¤.')">ì‘ì—… ì‚­ì œ</button>
                </form>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>ë¡œê·¸</h4>
                <button id="refreshBtn" class="btn btn-sm btn-outline-primary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="card-body">
                <div id="logContainer" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em; background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                    {% for log in logs %}
                    <div class="mb-2 log-entry">
                        <small class="text-muted">{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S KST') }}</small>
                        <span class="badge bg-{{ 'danger' if log.level == 'ERROR' else 'warning' if log.level == 'WARNING' else 'info' }}">
                            {{ log.level }}
                        </span>
                        <span>{{ log.message }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ìë™ ìƒˆë¡œê³ ì¹¨ (5ì´ˆë§ˆë‹¤)
let autoRefresh;

function updateJobStatus() {
    fetch('{{ url_for("dashboard.job_status", job_id=job.id) }}')
        .then(response => response.json())
        .then(data => {
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelector('.progress-bar').style.width = data.progress + '%';
            document.querySelector('.progress-bar').textContent = data.progress + '%';
            document.querySelector('.progress').nextElementSibling.textContent = 
                data.processed_items + '/' + data.total_items;
            
            // ë¡œê·¸ ì—…ë°ì´íŠ¸ (ìµœì‹  10ê°œ)
            const logContainer = document.getElementById('logContainer');
            if (data.logs && data.logs.length > 0) {
                let logsHtml = '';
                data.logs.forEach(log => {
                    const badgeClass = log.level === 'ERROR' ? 'danger' : 
                                    log.level === 'WARNING' ? 'warning' : 'info';
                    logsHtml += `
                        <div class="mb-2 log-entry">
                            <small class="text-muted">${log.created_at}</small>
                            <span class="badge bg-${badgeClass}">${log.level}</span>
                            <span>${log.message}</span>
                        </div>
                    `;
                });
                logContainer.innerHTML = logsHtml;
            }
            
            // ì‘ì—…ì´ ì™„ë£Œë˜ë©´ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
            if (data.status !== 'running' && data.status !== 'pending') {
                clearInterval(autoRefresh);
                // í˜ì´ì§€ ì „ì²´ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error));
}

// ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
document.getElementById('refreshBtn').addEventListener('click', updateJobStatus);

// ì‘ì—…ì´ ì§„í–‰ ì¤‘ì´ë©´ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
{% if job.status in ['pending', 'running'] %}
autoRefresh = setInterval(updateJobStatus, 5000);
{% endif %}
</script>
{% endblock %}

